#!/usr/bin/env bash
set -euo pipefail

# Resolve script location and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Source utilities and command libraries
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/network.sh"
source "$LIB_DIR/registry.sh"
source "$LIB_DIR/cluster.sh"
source "$LIB_DIR/argocd.sh"
source "$LIB_DIR/argocd-clusters.sh"
source "$LIB_DIR/kargo-shards.sh"
source "$LIB_DIR/istio-certs.sh"
source "$LIB_DIR/stack.sh"
source "$LIB_DIR/secrets.sh"

export PROJECT_ROOT

usage() {
  cat <<EOF
Usage: gitops <command> [subcommand] [target]

Multi-cluster GitOps local development environment.

Clusters:
  management-eu-central-1   Management cluster (ArgoCD, Kargo, Observability)
  dev-eu-central-1          Development workload cluster
  prod-eu-central-1         Production workload cluster

Commands:
  setup [target]            Full setup (clusters + argocd + register + stack)
  teardown [target]         Delete clusters and resources

  cluster create [target]   Create Kind cluster(s)
  cluster delete [target]   Delete Kind cluster(s)
  cluster status            Show cluster status

  argocd bootstrap [target] Bootstrap ArgoCD on cluster(s)
  argocd register-clusters  Register workload clusters with management ArgoCD (for Kargo)

  istio setup-certs         Generate and install Istio multi-cluster certs
  istio setup-remote        Setup Istio remote secrets for discovery

  kargo setup-shards        Setup Kargo controller shards on workload clusters

  stack deploy [target]     Deploy GitOps stack

  context <cluster>         Switch kubectl context

  secrets backup            Backup sealed secrets key
  secrets restore           Restore sealed secrets key from backup
  secrets status            Show sealed secrets status

  help                      Show this help message

Targets: all (default), management, dev, prod

Examples:
  gitops setup              # Complete setup of all clusters
  gitops setup management   # Setup management cluster only
  gitops teardown           # Delete all clusters
  gitops cluster status     # Show status of all clusters
  gitops context dev        # Switch to dev cluster context
EOF
}

cmd_setup() {
  local target=${1:-all}

  header "Multi-Cluster GitOps Stack - Complete Setup"

  info "Checking prerequisites..."
  require_command kind "brew install kind"
  require_command kubectl "brew install kubectl"
  require_command helm "brew install helm"
  require_command yq "brew install yq"
  require_command openssl "Should be pre-installed on macOS"

  KIND_VERSION=$(kind version | head -1 | awk '{print $2}')
  KUBECTL_VERSION=$(kubectl version --client -o yaml | grep gitVersion | awk '{print $2}')
  HELM_VERSION=$(helm version --short | cut -d'+' -f1)
  success "kind $KIND_VERSION"
  success "kubectl $KUBECTL_VERSION"
  success "helm $HELM_VERSION"

  header "Resource Requirements"
  if [[ "$target" == "all" ]]; then
    echo "  - CPU: 6 cores recommended (3 clusters)"
    echo "  - RAM: 16 GB recommended"
  else
    echo "  - CPU: 4 cores recommended"
    echo "  - RAM: 8 GB recommended"
  fi
  echo "  - Disk: 30 GB free space"
  echo "  - Time: 15-20 minutes"

  read -p "Do you want to continue? (y/n) " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    warn "Setup cancelled."
    exit 0
  fi

  info "Starting setup..."

  if [[ "$target" == "all" ]]; then
    header "Step 1/8: Creating clusters"
    cluster_create all

    header "Step 2/8: Setting up Istio certificates"
    istio_setup_certs

    header "Step 3/8: Bootstrapping ArgoCD on all clusters"
    argocd_bootstrap_all

    header "Step 4/8: Registering workload clusters with management ArgoCD (for Kargo)"
    argocd_register_clusters

    header "Step 5/8: Setting up Istio remote secrets"
    istio_setup_remote_secrets

    header "Step 6/8: Deploying GitOps Stack"
    stack_deploy all

    header "Step 7/8: Waiting for services to become ready"
    wait_for_url "https://argocd.localhost" 300 5

    header "Step 8/8: Setting up Kargo controller shards"
    kargo_setup_shards
  else
    header "Step 1/2: Creating cluster"
    cluster_create "$target"

    if [[ "$target" == "management" ]]; then
      header "Step 2/2: Bootstrapping ArgoCD"
      argocd_bootstrap
      stack_deploy management

      header "Waiting for services to become ready"
      wait_for_url "https://argocd.localhost" 300 5
    else
      info "Workload cluster '$target' created."
      echo "Run 'gitops argocd register-clusters' after management is ready."
    fi
  fi

  header "Setup Complete!"
  echo "The stack is deploying in the background."
  echo ""
  echo "Quick commands:"
  echo "  Watch deployment:  kubectl get applications -n argocd -w"
  echo "  Check pods:        kubectl get pods -A"
  echo "  Cluster status:    gitops cluster status"

  header "Service Access (after deployment completes)"
  echo "ArgoCD (Management):"
  echo "  URL:      https://argocd.localhost"
  echo "  Username: admin"
  echo "  Password: admin"
  echo ""
  echo "ArgoCD (Dev):"
  echo "  URL:      https://argocd-dev.localhost"
  echo "  Username: admin"
  echo "  Password: admin"
  echo ""
  echo "ArgoCD (Prod):"
  echo "  URL:      https://argocd-prod.localhost"
  echo "  Username: admin"
  echo "  Password: admin"
  echo ""
  echo "Grafana:"
  echo "  URL:      https://grafana.localhost"
  echo "  Username: admin"
  echo "  Password: admin"
  echo ""
  echo "Kargo:"
  echo "  URL:      https://kargo.localhost"
  echo "  Username: admin"
  echo "  Password: admin"
  echo ""
  echo "Note: Browser will show certificate warning (self-signed)."
  echo "      Click 'Advanced' -> 'Proceed' to continue."
}

# Main command dispatcher
case "${1:-}" in
  setup)
    cmd_setup "${2:-all}"
    ;;
  teardown)
    cluster_delete "${2:-all}"
    ;;
  cluster)
    case "${2:-}" in
      create) cluster_create "${3:-all}" ;;
      delete) cluster_delete "${3:-all}" ;;
      status) cluster_status ;;
      *) error "Unknown cluster command: ${2:-}"; echo "Usage: gitops cluster <create|delete|status> [target]"; exit 1 ;;
    esac
    ;;
  argocd)
    case "${2:-}" in
      bootstrap)
        if [[ "${3:-}" == "all" ]]; then
          argocd_bootstrap_all
        else
          argocd_bootstrap "${3:-management-eu-central-1}"
        fi
        ;;
      register-clusters) argocd_register_clusters ;;
      *) error "Unknown argocd command: ${2:-}"; echo "Usage: gitops argocd <bootstrap [target]|register-clusters>"; exit 1 ;;
    esac
    ;;
  istio)
    case "${2:-}" in
      setup-certs) istio_setup_certs ;;
      setup-remote) istio_setup_remote_secrets ;;
      *) error "Unknown istio command: ${2:-}"; echo "Usage: gitops istio <setup-certs|setup-remote>"; exit 1 ;;
    esac
    ;;
  kargo)
    case "${2:-}" in
      setup-shards) kargo_setup_shards ;;
      *) error "Unknown kargo command: ${2:-}"; echo "Usage: gitops kargo <setup-shards>"; exit 1 ;;
    esac
    ;;
  stack)
    case "${2:-}" in
      deploy) stack_deploy "${3:-all}" ;;
      *) error "Unknown stack command: ${2:-}"; echo "Usage: gitops stack deploy [target]"; exit 1 ;;
    esac
    ;;
  context)
    switch_context "${2:-}"
    ;;
  secrets)
    case "${2:-}" in
      backup) secrets_backup ;;
      restore) secrets_restore ;;
      status) secrets_status ;;
      *) error "Unknown secrets command: ${2:-}"; echo "Usage: gitops secrets <backup|restore|status>"; exit 1 ;;
    esac
    ;;
  help|-h|--help)
    usage
    ;;
  "")
    usage
    exit 1
    ;;
  *)
    error "Unknown command: $1"
    usage
    exit 1
    ;;
esac
