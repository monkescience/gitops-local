#!/usr/bin/env bash
set -euo pipefail

# Resolve script location and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Source utilities and command libraries
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/network.sh"
source "$LIB_DIR/cluster.sh"
source "$LIB_DIR/argocd.sh"
source "$LIB_DIR/kargo-shards.sh"
source "$LIB_DIR/istio-certs.sh"
source "$LIB_DIR/stack.sh"
source "$LIB_DIR/secrets.sh"

export PROJECT_ROOT

usage() {
  cat <<EOF
Usage: gitops <command> [subcommand]

Multi-cluster GitOps local development environment.

Clusters:
  management-eu-central-1   Management cluster (ArgoCD, Kargo, Observability)
  dev-eu-central-1          Development workload cluster
  prod-eu-central-1         Production workload cluster

Commands:
  setup                     Full setup (all clusters + stack)
  teardown                  Delete all clusters and resources

  cluster status            Show cluster status

  istio setup-certs         Regenerate Istio certificates

  context <cluster>         Switch kubectl context (management, dev, prod)

  secrets backup            Backup sealed secrets key
  secrets restore           Restore sealed secrets key from backup
  secrets status            Show sealed secrets status

  help                      Show this help message

Examples:
  gitops setup              # Complete setup of all clusters
  gitops teardown           # Delete all clusters
  gitops cluster status     # Show status of all clusters
  gitops context dev        # Switch to dev cluster context
EOF
}

cmd_setup() {
  header "Multi-Cluster GitOps Stack - Complete Setup"

  info "Checking prerequisites..."
  require_command k3d "brew install k3d"
  require_command kubectl "brew install kubectl"
  require_command helm "brew install helm"
  require_command yq "brew install yq"
  require_command jq "brew install jq"
  require_command openssl "Should be pre-installed on macOS"

  K3D_VERSION=$(k3d version | head -1 | awk '{print $3}')
  KUBECTL_VERSION=$(kubectl version --client -o yaml | grep gitVersion | awk '{print $2}')
  HELM_VERSION=$(helm version --short | cut -d'+' -f1)
  success "k3d $K3D_VERSION"
  success "kubectl $KUBECTL_VERSION"
  success "helm $HELM_VERSION"

  header "Resource Requirements"
  echo "  - CPU: 4 cores recommended (3 clusters)"
  echo "  - RAM: 12 GB recommended"
  echo "  - Disk: 25 GB free space"
  echo "  - Time: 10-15 minutes"

  read -p "Do you want to continue? (y/n) " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    warn "Setup cancelled."
    exit 0
  fi

  info "Starting setup..."

  # Interleaved setup: create cluster → certs → ArgoCD → root app
  # This allows ArgoCD to sync in background while next cluster is created

  header "Step 1/3: Setting up management cluster"
  cluster_create_single management-eu-central-1
  istio_setup_certs_single management-eu-central-1
  argocd_bootstrap management-eu-central-1
  stack_deploy_single management-eu-central-1
  info "Management cluster apps syncing in background..."

  header "Step 2/3: Setting up dev cluster"
  cluster_create_single dev-eu-central-1
  istio_setup_certs_single dev-eu-central-1
  argocd_bootstrap dev-eu-central-1
  stack_deploy_single dev-eu-central-1
  info "Dev cluster apps syncing in background..."

  header "Step 3/3: Setting up prod cluster"
  cluster_create_single prod-eu-central-1
  istio_setup_certs_single prod-eu-central-1
  argocd_bootstrap prod-eu-central-1
  stack_deploy_single prod-eu-central-1
  info "Prod cluster apps syncing in background..."

  header "Configuring cross-cluster networking"
  ensure_cross_cluster_network

  header "Waiting for services to become ready"
  wait_for_url "https://argocd.management.eu-central-1.localhost:8443" 300 5

  header "Setting up Kargo controller shards"
  kargo_setup_shards

  header "Setup Complete!"
  echo "The stack is deploying in the background."
  echo ""
  echo "Quick commands:"
  echo "  Watch deployment:  kubectl get applications -n argocd -w"
  echo "  Check pods:        kubectl get pods -A"
  echo "  Cluster status:    gitops cluster status"

  header "Service Access (after deployment completes)"
  echo "All services use admin/admin credentials."
  echo ""
  printf "%-12s %-12s %s\n" "Service" "Cluster" "URL"
  printf "%-12s %-12s %s\n" "-------" "-------" "---"
  printf "%-12s %-12s %s\n" "ArgoCD" "management" "https://argocd.management.eu-central-1.localhost:8443"
  printf "%-12s %-12s %s\n" "ArgoCD" "dev" "https://argocd.dev.eu-central-1.localhost:9443"
  printf "%-12s %-12s %s\n" "ArgoCD" "prod" "https://argocd.prod.eu-central-1.localhost:10443"
  printf "%-12s %-12s %s\n" "Grafana" "management" "https://grafana.management.eu-central-1.localhost:8443"
  printf "%-12s %-12s %s\n" "Kargo" "management" "https://kargo.management.eu-central-1.localhost:8443"
  printf "%-12s %-12s %s\n" "Kiali" "management" "https://kiali.management.eu-central-1.localhost:8443"
  printf "%-12s %-12s %s\n" "Kiali" "dev" "https://kiali.dev.eu-central-1.localhost:9443"
  printf "%-12s %-12s %s\n" "Kiali" "prod" "https://kiali.prod.eu-central-1.localhost:10443"
  echo ""
  echo "Note: Browser will show certificate warning (self-signed)."
  echo "      Click 'Advanced' -> 'Proceed' to continue."
}

# Main command dispatcher
case "${1:-}" in
  setup)
    cmd_setup
    ;;
  teardown)
    cluster_delete all
    ;;
  cluster)
    case "${2:-}" in
      status) cluster_status ;;
      *) error "Unknown cluster command: ${2:-}"; echo "Usage: gitops cluster status"; exit 1 ;;
    esac
    ;;
  istio)
    case "${2:-}" in
      setup-certs) istio_setup_certs ;;
      *) error "Unknown istio command: ${2:-}"; echo "Usage: gitops istio setup-certs"; exit 1 ;;
    esac
    ;;
  context)
    switch_context "${2:-}"
    ;;
  secrets)
    case "${2:-}" in
      backup) secrets_backup ;;
      restore) secrets_restore ;;
      status) secrets_status ;;
      *) error "Unknown secrets command: ${2:-}"; echo "Usage: gitops secrets <backup|restore|status>"; exit 1 ;;
    esac
    ;;
  help|-h|--help)
    usage
    ;;
  "")
    usage
    exit 1
    ;;
  *)
    error "Unknown command: $1"
    usage
    exit 1
    ;;
esac
