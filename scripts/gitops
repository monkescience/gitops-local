#!/usr/bin/env bash
set -euo pipefail

# Resolve script location and project root
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Source utilities and command libraries
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/network.sh"
source "$LIB_DIR/cluster.sh"
source "$LIB_DIR/argocd.sh"
source "$LIB_DIR/kargo-shards.sh"
source "$LIB_DIR/istio-certs.sh"
source "$LIB_DIR/stack.sh"
source "$LIB_DIR/secrets.sh"

export PROJECT_ROOT

usage() {
  cat <<EOF
Usage: gitops <command> [subcommand]

Multi-cluster GitOps local development environment.

Clusters:
  management-eu-central-1   Management cluster (ArgoCD, Kargo, Observability)
  dev-eu-central-1          Development workload cluster
  prod-eu-central-1         Production workload cluster

Commands:
  setup                     Full setup (all clusters + stack)
  teardown                  Delete all clusters and resources

  cluster status            Show cluster status

  istio setup-certs         Regenerate Istio certificates

  context <cluster>         Switch kubectl context (management, dev, prod)

  secrets backup            Backup sealed secrets key
  secrets restore           Restore sealed secrets key from backup
  secrets status            Show sealed secrets status

  help                      Show this help message

Examples:
  gitops setup              # Complete setup of all clusters
  gitops teardown           # Delete all clusters
  gitops cluster status     # Show status of all clusters
  gitops context dev        # Switch to dev cluster context
EOF
}

cmd_setup() {
  header "Multi-Cluster GitOps Stack - Complete Setup"

  info "Checking prerequisites..."
  require_command kind "brew install kind"
  require_command kubectl "brew install kubectl"
  require_command helm "brew install helm"
  require_command yq "brew install yq"
  require_command openssl "Should be pre-installed on macOS"

  KIND_VERSION=$(kind version | head -1 | awk '{print $2}')
  KUBECTL_VERSION=$(kubectl version --client -o yaml | grep gitVersion | awk '{print $2}')
  HELM_VERSION=$(helm version --short | cut -d'+' -f1)
  success "kind $KIND_VERSION"
  success "kubectl $KUBECTL_VERSION"
  success "helm $HELM_VERSION"

  header "Resource Requirements"
  echo "  - CPU: 6 cores recommended (3 clusters)"
  echo "  - RAM: 16 GB recommended"
  echo "  - Disk: 30 GB free space"
  echo "  - Time: 15-20 minutes"

  read -p "Do you want to continue? (y/n) " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    warn "Setup cancelled."
    exit 0
  fi

  info "Starting setup..."

  header "Step 1/5: Creating clusters"
  cluster_create all

  header "Step 2/5: Setting up Istio certificates"
  istio_setup_certs

  header "Step 3/5: Bootstrapping ArgoCD and deploying root apps"
  argocd_bootstrap_all

  header "Step 4/5: Waiting for services to become ready"
  wait_for_url "https://argocd.management.eu-central-1.localhost:8443" 300 5

  header "Step 5/5: Setting up Kargo controller shards"
  kargo_setup_shards

  header "Setup Complete!"
  echo "The stack is deploying in the background."
  echo ""
  echo "Quick commands:"
  echo "  Watch deployment:  kubectl get applications -n argocd -w"
  echo "  Check pods:        kubectl get pods -A"
  echo "  Cluster status:    gitops cluster status"

  header "Service Access (after deployment completes)"
  echo "All services use admin/admin credentials."
  echo ""
  printf "%-12s %-12s %s\n" "Service" "Cluster" "URL"
  printf "%-12s %-12s %s\n" "-------" "-------" "---"
  printf "%-12s %-12s %s\n" "ArgoCD" "management" "https://argocd.management.eu-central-1.localhost:8443"
  printf "%-12s %-12s %s\n" "ArgoCD" "dev" "https://argocd.dev.eu-central-1.localhost:9443"
  printf "%-12s %-12s %s\n" "ArgoCD" "prod" "https://argocd.prod.eu-central-1.localhost:10443"
  printf "%-12s %-12s %s\n" "Grafana" "management" "https://grafana.management.eu-central-1.localhost:8443"
  printf "%-12s %-12s %s\n" "Kargo" "management" "https://kargo.management.eu-central-1.localhost:8443"
  printf "%-12s %-12s %s\n" "Kiali" "management" "https://kiali.management.eu-central-1.localhost:8443"
  printf "%-12s %-12s %s\n" "Kiali" "dev" "https://kiali.dev.eu-central-1.localhost:9443"
  printf "%-12s %-12s %s\n" "Kiali" "prod" "https://kiali.prod.eu-central-1.localhost:10443"
  echo ""
  echo "Note: Browser will show certificate warning (self-signed)."
  echo "      Click 'Advanced' -> 'Proceed' to continue."
}

# Main command dispatcher
case "${1:-}" in
  setup)
    cmd_setup
    ;;
  teardown)
    cluster_delete all
    ;;
  cluster)
    case "${2:-}" in
      status) cluster_status ;;
      *) error "Unknown cluster command: ${2:-}"; echo "Usage: gitops cluster status"; exit 1 ;;
    esac
    ;;
  istio)
    case "${2:-}" in
      setup-certs) istio_setup_certs ;;
      *) error "Unknown istio command: ${2:-}"; echo "Usage: gitops istio setup-certs"; exit 1 ;;
    esac
    ;;
  context)
    switch_context "${2:-}"
    ;;
  secrets)
    case "${2:-}" in
      backup) secrets_backup ;;
      restore) secrets_restore ;;
      status) secrets_status ;;
      *) error "Unknown secrets command: ${2:-}"; echo "Usage: gitops secrets <backup|restore|status>"; exit 1 ;;
    esac
    ;;
  help|-h|--help)
    usage
    ;;
  "")
    usage
    exit 1
    ;;
  *)
    error "Unknown command: $1"
    usage
    exit 1
    ;;
esac
