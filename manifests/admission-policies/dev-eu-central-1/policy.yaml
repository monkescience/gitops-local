apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: require-resource-constraints
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: [""]
        apiVersions: ["v1"]
        operations: ["CREATE", "UPDATE"]
        resources: ["pods"]
  validations:
    - expression: >-
        object.spec.containers.all(c, c.?resources.?requests['cpu'].hasValue())
      message: "All containers must have cpu requests defined"
      reason: Invalid
    - expression: >-
        object.spec.containers.all(c, !c.?resources.?limits['cpu'].hasValue())
      message: "Containers must not have cpu limits defined"
      reason: Invalid
    - expression: >-
        object.spec.containers.all(c, c.?resources.?requests['memory'].hasValue())
      message: "All containers must have memory requests defined"
      reason: Invalid
    - expression: >-
        object.spec.containers.all(c, c.?resources.?limits['memory'].hasValue())
      message: "All containers must have memory limits defined"
      reason: Invalid
    - expression: >-
        object.spec.containers.all(c,
          c.?resources.?requests['memory'].optMap(req,
            c.?resources.?limits['memory'].optMap(lim, req == lim)
          ).orValue(optional.of(true)).orValue(true))
      message: "Memory request must equal memory limit"
      reason: Invalid
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: require-resource-constraints-binding
spec:
  policyName: require-resource-constraints
  validationActions:
    - Audit
  matchResources: {}
